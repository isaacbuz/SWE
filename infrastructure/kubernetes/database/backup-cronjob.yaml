---
# CronJob for automated database backups
apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-backup
  namespace: piehr
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM UTC
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-sa
          containers:
            - name: backup
              image: postgres:15-alpine
              env:
                - name: POSTGRES_HOST
                  valueFrom:
                    secretKeyRef:
                      name: database-credentials
                      key: host
                - name: POSTGRES_PORT
                  value: "5432"
                - name: POSTGRES_DB
                  valueFrom:
                    secretKeyRef:
                      name: database-credentials
                      key: database
                - name: POSTGRES_USER
                  valueFrom:
                    secretKeyRef:
                      name: database-credentials
                      key: user
                - name: POSTGRES_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: database-credentials
                      key: password
                - name: BACKUP_DIR
                  value: "/backups"
                - name: GCS_BUCKET
                  value: "piehr-backups"
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  TIMESTAMP=$(date +%Y%m%d_%H%M%S)
                  BACKUP_FILE="piehr_backup_${TIMESTAMP}.sql"
                  
                  echo "Creating backup: $BACKUP_FILE"
                  PGPASSWORD=$POSTGRES_PASSWORD pg_dump \
                    -h $POSTGRES_HOST \
                    -p $POSTGRES_PORT \
                    -U $POSTGRES_USER \
                    -d $POSTGRES_DB \
                    -F c \
                    -f $BACKUP_DIR/$BACKUP_FILE
                  
                  echo "Uploading backup to GCS..."
                  gsutil cp $BACKUP_DIR/$BACKUP_FILE gs://$GCS_BUCKET/
                  
                  echo "Cleaning up local backup..."
                  rm -f $BACKUP_DIR/$BACKUP_FILE
                  
                  echo "Backup completed successfully"
              volumeMounts:
                - name: backups
                  mountPath: /backups
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "100m"
                limits:
                  memory: "512Mi"
                  cpu: "500m"
          volumes:
            - name: backups
              emptyDir: {}
          restartPolicy: OnFailure

---
# Service Account for backup job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backup-sa
  namespace: piehr
  annotations:
    iam.gke.io/gcp-service-account: backup-sa@PROJECT_ID.iam.gserviceaccount.com

---
# Role for backup job (GCS access)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: backup-role
  namespace: piehr
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]

---
# RoleBinding for backup job
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: backup-rolebinding
  namespace: piehr
subjects:
  - kind: ServiceAccount
    name: backup-sa
    namespace: piehr
roleRef:
  kind: Role
  name: backup-role
  apiGroup: rbac.authorization.k8s.io

