name: Security Scan

on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM
  workflow_dispatch:
  push:
    branches: [main, develop]
    paths:
      - '**/*.py'
      - '**/*.js'
      - '**/*.ts'
      - '**/Dockerfile*'
      - '**/package.json'
      - '**/requirements.txt'

jobs:
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          npm ci
          pip install pip-audit
      
      - name: Scan Node.js dependencies
        run: |
          npm audit --audit-level=moderate --json > npm-audit.json || true
      
      - name: Scan Python dependencies
        run: |
          pip-audit --format=json > pip-audit.json || true
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-results
          path: |
            npm-audit.json
            pip-audit.json

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: gitleaks-report.json

  container-scan:
    name: Container Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Trivy
        uses: aquasecurity/trivy-action@master
        with:
          trivy-version: 'latest'
      
      - name: Scan Dockerfiles
        run: |
          find . -name "Dockerfile" -o -name "*.dockerfile" | while read dockerfile; do
            trivy fs --format json --output "trivy-$(basename ${dockerfile}).json" "${dockerfile}" || true
          done
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-results
          path: trivy-*.json

  code-scan:
    name: Code Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Bandit
        run: pip install bandit
      
      - name: Scan Python code
        run: |
          bandit -r apps/api packages -f json -o bandit-report.json || true
      
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: code-scan-results
          path: bandit-report.json

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, secret-scan, container-scan, code-scan]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "Date: $(date)" >> security-summary.md
          echo "" >> security-summary.md
          echo "## Scans Completed" >> security-summary.md
          echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> security-summary.md
          echo "- Secret Scan: ${{ needs.secret-scan.result }}" >> security-summary.md
          echo "- Container Scan: ${{ needs.container-scan.result }}" >> security-summary.md
          echo "- Code Scan: ${{ needs.code-scan.result }}" >> security-summary.md
      
      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-summary
          path: security-summary.md

