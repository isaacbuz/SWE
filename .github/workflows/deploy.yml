name: Deploy Application

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
  workflow_dispatch:

env:
  REGISTRY: gcr.io
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run secret scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug

      - name: Check for environment variable leaks
        run: |
          echo "Scanning for hardcoded secrets..."
          ! grep -r "password=" . --include="*.js" --include="*.ts" --include="*.py" --include="*.java"
          ! grep -r "api_key=" . --include="*.js" --include="*.ts" --include="*.py"
          ! grep -r "secret=" . --include="*.js" --include="*.ts" --include="*.py"
          echo "No hardcoded secrets found!"

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: security-checks
    permissions:
      contents: read
      id-token: write
    outputs:
      image: ${{ steps.image.outputs.image }}
      tag: ${{ steps.image.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Configure Docker to use gcloud
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Generate image metadata
        id: image
        run: |
          TAG="${GITHUB_SHA:0:7}"
          IMAGE="${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/ai-company-app:${TAG}"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Building image: ${IMAGE}"

      - name: Build Docker image
        run: |
          docker build \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg VERSION=${{ steps.image.outputs.tag }} \
            -t ${{ steps.image.outputs.image }} \
            -t ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/ai-company-app:latest \
            .

      - name: Scan image for vulnerabilities
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            ${{ steps.image.outputs.image }}

      - name: Push Docker image
        run: |
          docker push ${{ steps.image.outputs.image }}
          docker push ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/ai-company-app:latest

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ai-company-gke-staging \
            --region us-central1

      - name: Update secrets from Google Secret Manager
        run: |
          # Pull secrets from Google Secret Manager
          kubectl create secret generic app-secrets \
            --from-literal=DATABASE_URL=$(gcloud secrets versions access latest --secret=database-url) \
            --from-literal=REDIS_URL=$(gcloud secrets versions access latest --secret=redis-url) \
            --from-literal=JWT_SECRET=$(gcloud secrets versions access latest --secret=jwt-secret) \
            --from-literal=ENCRYPTION_KEY=$(gcloud secrets versions access latest --secret=encryption-key) \
            -n staging \
            --dry-run=client \
            -o yaml | kubectl apply -f -

      - name: Deploy to Staging
        run: |
          kubectl set image deployment/ai-company-app \
            app=${{ needs.build.outputs.image }} \
            -n staging
          kubectl rollout status deployment/ai-company-app -n staging --timeout=5m

      - name: Run smoke tests
        run: |
          STAGING_URL="https://api-staging.aicompany.com"
          curl -f "${STAGING_URL}/health" || exit 1
          echo "Staging deployment healthy!"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      auto_merge: false  # Require manual approval
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials ai-company-gke-prod \
            --region us-central1

      - name: Update secrets from Google Secret Manager
        run: |
          # Pull secrets from Google Secret Manager
          # Note: External Secrets Operator typically handles this automatically
          # This is a manual fallback
          kubectl create secret generic app-secrets \
            --from-literal=DATABASE_URL=$(gcloud secrets versions access latest --secret=database-password-prod) \
            --from-literal=REDIS_URL=$(gcloud secrets versions access latest --secret=redis-url-prod) \
            --from-literal=JWT_SECRET=$(gcloud secrets versions access latest --secret=jwt-secret-prod) \
            --from-literal=ENCRYPTION_KEY=$(gcloud secrets versions access latest --secret=encryption-key-prod) \
            -n production \
            --dry-run=client \
            -o yaml | kubectl apply -f -

      - name: Create deployment backup
        run: |
          kubectl get deployment ai-company-app -n production -o yaml > /tmp/deployment-backup-${{ github.sha }}.yaml
          echo "Backup created"

      - name: Deploy to Production
        run: |
          kubectl set image deployment/ai-company-app \
            app=${{ needs.build.outputs.image }} \
            -n production
          kubectl rollout status deployment/ai-company-app -n production --timeout=10m

      - name: Verify production health
        run: |
          PROD_URL="https://api.aicompany.com"
          curl -f "${PROD_URL}/health" || exit 1
          echo "Production deployment healthy!"

      - name: Run post-deployment tests
        run: |
          # Run smoke tests
          npm run test:e2e:production || true

      - name: Notify deployment
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              text: `Production deployment successful!`,
              attachments: [{
                color: 'good',
                fields: [{
                  title: 'Commit',
                  value: `${{ github.sha }}`,
                  short: true
                },
                {
                  title: 'Author',
                  value: `${{ github.actor }}`,
                  short: true
                },
                {
                  title: 'Image',
                  value: `${{ needs.build.outputs.image }}`,
                  short: false
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          kubectl rollout undo deployment/ai-company-app -n production
          kubectl rollout status deployment/ai-company-app -n production --timeout=5m

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.ref == 'refs/heads/main' && success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          CHANGELOG=$(git log --oneline ${{ github.event.before }}..${{ github.sha }} | head -20)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          body: |
            ## Changes in this Release
            ${{ steps.changelog.outputs.changelog }}

            ## Deployment
            - **Image**: ${{ needs.build.outputs.image }}
            - **Commit**: ${{ github.sha }}
            - **Author**: ${{ github.actor }}

            For detailed logs, see the [Actions workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          draft: false
          prerelease: false
